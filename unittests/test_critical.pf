module test_critical
  use eoslibinit, only: init_thermo
  use critical, only: calcCritical, calcCriticalTV
  use thermopack_constants, only: VAPPH
  use eosTV, only: pressure
  use funit
  implicit none
  public

contains

  @Test
  subroutine test_critical_point_co2n2()
    ! Test a single critical point
    real, dimension(2) :: z
    real :: p, T, v, tol
    integer :: ierr

    call init_thermo('PR', 'vdW', 'Classic', "CO2,N2", 2)

    z = [0.8, &
         0.2]

    T = 280.0
    p = 1.0e7

    call calcCritical(t,p,Z,VAPPH,ierr)
    @assertTrue(ierr == 0)
    @assertEqual(287.57458524483229, T, 1e-06)
    @assertEqual(10407983.561280208, p, 1e-01)

    T = -1.0
    v = -1.0
    tol = 1.0e-7
    call calcCriticalTV(t,v,Z,ierr,tol)
    @assertTrue(ierr == 0)
    p = pressure(T,v,Z)
    @assertEqual(0.86176300888142712E-4, v, 1e-10)
    @assertEqual(287.57458332896459, T, 5e-06)
    @assertEqual(104.07983913703155e5, p, 1.0)

  end subroutine test_critical_point_co2n2

  @Test
  subroutine test_critical_point_mix()
    ! Test a single critical point
    real, dimension(5) :: z
    real :: p, T, v, tol
    integer :: ierr

    call init_thermo('PR', 'vdW', 'Classic',&
         "CO2,H2,N2,O2,C1", 2)

    z = [0.9103,&
         0.0115,&
         0.0400,&
         0.0187,&
         0.0195]

    T = 295.0
    p = 80.0e5

    call calcCritical(t,p,Z,VAPPH,ierr)
    @assertTrue(ierr == 0)
    @assertEqual(297.98685486941611, T, 1e-06)
    @assertEqual(8608638.9174540266 , p, 1e-01)

    T = -1.0
    v = -1.0
    tol = 1.0e-7
    call calcCriticalTV(t,v,Z,ierr,tol)
    @assertTrue(ierr == 0)
    p = pressure(T,v,Z)
    @assertEqual(0.97322465628207284E-4, v, 5e-10)
    @assertEqual(297.98685486941611, T, 5e-05)
    @assertEqual(8608639.5027953647, p, 1.0)

  end subroutine test_critical_point_mix

  @Test
  subroutine test_critical_point_co2()
    ! Test a single critical point
    real, dimension(1) :: zs
    real :: p, T, v, tol
    integer :: ierr

    call init_thermo('PC-SAFT', 'vdW', 'Classic',&
         "CO2", 2,saft_ref="DEFAULT")
    zs = 1.0
    T = -1.0
    v = -1.0
    tol = 1.0e-7
    call calcCriticalTV(t,v,zs,ierr,tol)
    @assertTrue(ierr == 0)
    p = pressure(T,v,zs)
    @assertEqual(0.9976419E-04, v, 1e-10)
    @assertEqual(310.2768, T, 1e-06)
    @assertEqual(8063916.3, p, 1.0)

  end subroutine test_critical_point_co2

end module test_critical
